---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'

import { Paginator, PostPreview } from 'astro-pure/components/pages'
import {
  getBlogCollection,
  getCollectionsByCategory,
  getUniqueCategories,
  getUniqueTagsWithCount,
  sortMDByDate
} from 'astro-pure/server'
import { Button, Icon } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import config from '@/site-config'

export const prerender = true

const categoryMap: Record<string, string> = {
  Research: 'Research',
  Technical: 'Technical',
  Daily: 'Daily',
  Essays: 'Essays'
}

export const getStaticPaths = (async ({ paginate }) => {
  const categoryOrder = ['Research', 'Technical', 'Daily', 'Essays']
  const allPosts = await getBlogCollection()
  const allCategories = getUniqueCategories(allPosts)
  const categoryLookup = new Map(allCategories.map((c) => [c.toLowerCase(), c] as const))

  const categories = categoryOrder
    .map((c) => categoryLookup.get(c.toLowerCase()))
    .filter((c): c is string => Boolean(c))

  return categories.flatMap((category) => {
    const posts = sortMDByDate(getCollectionsByCategory(allPosts, category))
    const uniqueTags = getUniqueTagsWithCount(posts).map(([tag]) => tag)
    return paginate(posts, {
      params: { category },
      pageSize: config.content.blogPageSize,
      props: { category, uniqueTags, collectionsCount: posts.length }
    })
  })
}) satisfies GetStaticPaths

interface Props {
  page: Page<CollectionEntry<'blog'>>
  category: string
  uniqueTags: string[]
  collectionsCount: number
}

const { page, category, uniqueTags, collectionsCount } = Astro.props
const categoryDisplayName = categoryMap[category] || category

const meta = {
  description: `Posts in category: ${categoryDisplayName}`,
  title: `${categoryDisplayName} - Blog`
}

const paginationProps = {
  ...(page.url.prev && { prevUrl: { text: 'Previous', url: page.url.prev } }),
  ...(page.url.next && { nextUrl: { text: 'Next', url: page.url.next } })
}
---

<PageLayout {meta}>
  <Button title='Back' href='/' variant='back' />
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 mt-6 text-3xl font-medium sm:mt-10'>{categoryDisplayName}</h1>
    </div>

    <div class='grid gap-y-16 sm:grid-cols-[3fr_1fr] sm:gap-x-8'>
      <section aria-label='Blog posts list' class='animate' id='content'>
        <div class='mb-3 flex flex-col justify-between text-sm sm:mb-5 sm:flex-row'>
          <span class='text-muted-foreground'>
            Page {page.currentPage} - Showing {page.data.length} of {collectionsCount} posts
          </span>
          <a href='/archives' data-astro-prefetch>View all posts by years</a>
        </div>

        <ul class='flex flex-col gap-y-4 text-start'>
          {page.data.map((post) => (
            <PostPreview {post} detailed />
          ))}
        </ul>

        <Paginator {...paginationProps} />
      </section>

      {!!uniqueTags.length && (
        <aside class='animate' id='sidebar'>
          <h2 class='mb-4 flex items-center text-lg font-medium'>
            <Icon name='tag-2' class='me-2' />
            Tags
          </h2>
          <ul class='text-bgColor flex flex-wrap gap-2'>
            {uniqueTags.slice(0, 50).map((tag) => (
              <li><Button title={tag} href={`/tags/${tag}`} variant='pill' /></li>
            ))}
          </ul>
        </aside>
      )}
    </div>
  </main>
</PageLayout>
